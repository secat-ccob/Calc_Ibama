<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="Calculadora oficial de juros SELIC acumulado - SECAT/CCOB/Ibama. Dados atualizados da Receita Federal.">
    <title>CALC IBAMA</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            background-color: #f0f0f0;
            margin: 0;
            padding: 20px;
        }
        
        .container {
            max-width: 1000px;
            margin: 0 auto;
            background-color: white;
            border: 1px solid #ccc;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        
        .title {
            background-color: #1f4e79;
            color: white;
            text-align: center;
            padding: 12px;
            font-size: 16px;
            font-weight: bold;
            margin: 0;
        }
        
        .update-section {
            display: flex;
            align-items: center;
            background-color: #1f4e79;
            color: white;
            padding: 8px 12px;
            font-weight: bold;
        }
        
        .update-section input {
            margin-left: 10px;
            padding: 4px 8px;
            border: 1px solid #ccc;
            background-color: white;
            width: 100px;
            text-align: center;
            font-weight: bold;
            color: black;
        }
        
        table {
            width: 100%;
            border-collapse: collapse;
            margin: 0;
        }
        
        .header-row {
            background-color: #1f4e79;
            color: white;
            font-weight: bold;
            text-align: center;
        }
        
        .header-row td {
            padding: 8px;
            border: 1px solid #ccc;
        }
        
        .data-row td {
            padding: 8px;
            border: 1px solid #ccc;
            text-align: center;
        }
        
        .gray-cell {
            background-color: #e0e0e0;
        }
        
        .blue-cell {
            background-color: #1f4e79;
            color: white;
            font-weight: bold;
        }
        
        .white-cell {
            background-color: white;
        }
        
        .green-footer {
            background-color: #e0e0e0;
            color: black;
            font-weight: bold;
            text-align: center;
            border: 1px solid #ccc;
        }
        
        input {
            border: none;
            background: transparent;
            width: 100%;
            text-align: center;
            font-size: 14px;
            color: inherit;
            font-weight: inherit;
        }
        
        input:focus {
            outline: 2px solid #4CAF50;
        }
        
        input[readonly] {
            cursor: default;
        }
        
        .buttons {
            text-align: center;
            padding: 15px;
            background-color: white;
        }
        
        .btn {
            background-color: #e0e0e0;
            color: black;
            border: 1px solid #ccc;
            padding: 8px 16px;
            margin: 0 5px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
            font-weight: bold;
        }
        
        .btn:hover {
            background-color: #d0d0d0;
        }
        
        .loading {
            color: #666;
            font-style: italic;
        }
        
        .empty-row {
            height: 25px;
        }
        
        .alert {
            background-color: #fff3cd;
            border: 1px solid #ffeaa7;
            color: #856404;
            padding: 10px;
            margin: 10px;
            border-radius: 4px;
            display: none;
        }
        
        .success {
            background-color: #d4edda;
            border-color: #c3e6cb;
            color: #155724;
        }
        
        .error {
            background-color: #f8d7da;
            border-color: #f5c6cb;
            color: #721c24;
        }
        
        .status-info {
            background-color: #e2e3e5;
            border: 1px solid #d6d8db;
            color: #383d41;
            padding: 8px;
            margin: 10px;
            border-radius: 4px;
            font-size: 12px;
        }
        
        /* ESTILOS DE IMPRESS√ÉO - BORDA INTELIGENTE */
        @media print {
            body { 
                background-color: white; 
                margin: 0; 
                padding: 10px; 
            }
            
            .buttons { 
                display: none; 
            }
            
            #alertas, #statusInfo { 
                display: none; 
            }
            
            .container { 
                box-shadow: none; 
                border: 1px solid #000;
            }
            
            table {
                border-collapse: collapse;
                border: 1px solid #000;
            }
            
            .header-row td {
                border: 1px solid #000;
                padding: 8px;
            }
            
            .data-row[data-linha] td {
                border: 1px solid #000;
                padding: 8px;
            }
            
            .total-row td {
                border: 1px solid #000;
                padding: 8px;
            }
            
            .empty-row {
                display: none;
            }
            
            .header-row {
                background-color: #1f4e79 !important;
                color: white !important;
            }
            
            .gray-cell {
                background-color: #f5f5f5 !important;
            }
            
            .white-cell {
                background-color: white !important;
            }
            
            .green-footer {
                background-color: #f0f0f0 !important;
                color: black !important;
                font-weight: bold;
            }
            
            .title {
                font-size: 18px;
                padding: 15px;
                background-color: #1f4e79 !important;
                color: white !important;
            }
            
            .update-section {
                background-color: #1f4e79 !important;
                color: white !important;
            }
            
            .update-section input {
                background-color: white !important;
                color: black !important;
                border: 1px solid #000 !important;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="title">
            Calculadora de Taxa Selic Acumulada - SECAT / CCOB
        </div>
        
        <div class="update-section">
            M√™s de atualiza√ß√£o (mm/aaaa):
            <input type="text" id="mesReferencia" value="" maxlength="7" onblur="formatarData(this); atualizarTodasLinhas()">
        </div>
        
        <div id="alertas" class="alert"></div>
        <div id="statusInfo" class="status-info">üîÑ Carregando dados da planilha oficial...</div>
        
        <table id="tabelaSelic">
            <tbody>
                <tr class="header-row">
                    <td>Valor original (R$)</td>
                    <td>Vencimento (mm/aaaa)</td>
                    <td>Taxa SELIC acumulada (%)</td>
                    <td>Valor atualizado (R$)</td>
                </tr>
                
                <tr class="data-row" data-linha="0">
                    <td class="white-cell">
                        <input type="text" class="valor-pagamento" placeholder="0,00" onblur="formatarMoeda(this); calcularLinha(0)">
                    </td>
                    <td class="white-cell">
                        <input type="text" class="data-pagamento" placeholder="MM/AAAA" maxlength="7" onblur="formatarData(this); calcularLinha(0)">
                    </td>
                    <td class="gray-cell">
                        <input type="text" class="taxa-selic" readonly>
                    </td>
                    <td class="gray-cell">
                        <input type="text" class="valor-atualizado" readonly>
                    </td>
                </tr>
                
                <tr class="empty-row"><td colspan="4"></td></tr>
                
                <tr class="data-row total-row">
                    <td colspan="2" style="border: none;"></td>
                    <td class="green-footer">Total atualizado:</td>
                    <td class="green-footer">
                        <input type="text" id="valorTotal" readonly>
                    </td>
                </tr>
            </tbody>
        </table>
        
        <div class="buttons">
            <button class="btn" onclick="adicionarLinha()">+ Adicionar Linha</button>
            <button class="btn" onclick="removerLinha()">- Remover Linha</button>
            <button class="btn" onclick="imprimirPagina()">üñ®Ô∏è Imprimir</button>
            <button class="btn" onclick="buscarDadosOnline()">üîÑ Atualizar Dados</button>
        </div>
    </div>

    <script>
        let contadorLinhas = 1;
        let dadosPlanilha = {};
        let statusConexao = 'carregando';
        
        // **FUN√á√ÉO PARA OBTER M√äS VIGENTE AUTOMATICAMENTE**
        function obterMesVigente() {
            const agora = new Date();
            const mes = (agora.getMonth() + 1).toString().padStart(2, '0'); // +1 porque getMonth() √© 0-indexado
            const ano = agora.getFullYear();
            
            const mesVigente = `${mes}/${ano}`;
            console.log(`üìÖ M√™s vigente detectado: ${mesVigente}`);
            
            return mesVigente;
        }
        
        // **DEFINIR M√äS VIGENTE NO CARREGAMENTO**
        function definirMesVigente() {
            const campoMesReferencia = document.getElementById('mesReferencia');
            if (campoMesReferencia) {
                const mesVigente = obterMesVigente();
                campoMesReferencia.value = mesVigente;
                console.log(`‚úÖ Campo definido para m√™s vigente: ${mesVigente}`);
            }
        }
        
        function atualizarStatus(mensagem, sucesso = true) {
            const statusDiv = document.getElementById('statusInfo');
            if (statusDiv) {
                statusDiv.innerHTML = mensagem;
                statusDiv.style.color = sucesso ? '#155724' : '#721c24';
            }
        }
        
        function mostrarAlerta(mensagem, tipo = 'info') {
            const alertaDiv = document.getElementById('alertas');
            if (alertaDiv) {
                alertaDiv.innerHTML = mensagem;
                alertaDiv.className = 'alert ' + tipo;
                alertaDiv.style.display = 'block';
                setTimeout(() => {
                    alertaDiv.style.display = 'none';
                }, 5000);
            }
        }
        
        function formatarMoeda(input) {
            let valor = input.value.trim();
            
            if (valor === '') {
                input.value = '';
                return;
            }
            
            let valorNumerico;
            
            if (valor.includes('.') || valor.includes(',')) {
                valor = valor.replace(',', '.');
                valorNumerico = parseFloat(valor);
                
                if (isNaN(valorNumerico) || valorNumerico < 0) {
                    input.value = '';
                    mostrarAlerta('Valor inv√°lido. Use formato: 123,45 ou 123.45', 'error');
                    return;
                }
                
                console.log(`üí∞ Com decimais: "${input.value}" ‚Üí ${valorNumerico}`);
                
            } else {
                const valorLimpo = valor.replace(/\D/g, '');
                valorNumerico = parseInt(valorLimpo) || 0;
                
                console.log(`üí∞ Sem decimais: "${input.value}" ‚Üí ${valorNumerico} reais`);
            }
            
            let valorFormatado = valorNumerico.toFixed(2);
            valorFormatado = valorFormatado.replace('.', ',');
            valorFormatado = valorFormatado.replace(/(\d)(?=(\d{3})+(?!\d))/g, '$1.');
            
            input.value = valorFormatado;
            console.log(`üí∞ Resultado: "${valorFormatado}"`);
        }
        
        function imprimirPagina() {
            mostrarAlerta('üìÑ Preparando PDF com borda inteligente...', 'success');
            
            const elementosParaOcultar = ['#alertas', '#statusInfo', '.buttons'];
            const elementosOcultos = [];
            
            elementosParaOcultar.forEach(seletor => {
                const elemento = document.querySelector(seletor);
                if (elemento && elemento.style.display !== 'none') {
                    elementosOcultos.push({elemento, displayOriginal: elemento.style.display});
                    elemento.style.display = 'none';
                }
            });
            
            setTimeout(() => {
                window.print();
                
                setTimeout(() => {
                    elementosOcultos.forEach(({elemento, displayOriginal}) => {
                        elemento.style.display = displayOriginal || 'block';
                    });
                    
                    mostrarAlerta('‚úÖ Para PDF: Escolha "Salvar como PDF" na janela de impress√£o.', 'success');
                }, 1000);
            }, 500);
        }
        
        async function buscarDadosOnline() {
            atualizarStatus('üîÑ Buscando dados atualizados da planilha oficial...', true);
            
            try {
                const proxies = [
                    'https://api.allorigins.win/get?url=',
                    'https://corsproxy.io/?'
                ];
                
                const urlPlanilha = 'https://diariofiscal.com.br/selic__rfb_.html?ms=AQAAAAAAABA%3D&st=MA%3D%3D&sct=MTA3NC40MDAwMjQ0MTQwNjI1&mw=MjQw#loaded';
                
                let dadosObtidos = false;
                
                for (const proxy of proxies) {
                    try {
                        let url = proxy.includes('allorigins') ? 
                            proxy + encodeURIComponent(urlPlanilha) : 
                            proxy + urlPlanilha;
                        
                        const response = await fetch(url);
                        let html = proxy.includes('allorigins') ? 
                            (await response.json()).contents : 
                            await response.text();
                        
                        if (html && html.length > 5000) {
                            extrairDadosCompletoDaPlanilha(html);
                            dadosObtidos = true;
                            break;
                        }
                        
                    } catch (error) {
                        console.log(`Erro no proxy ${proxy}:`, error);
                        continue;
                    }
                }
                
                if (!dadosObtidos) {
                    throw new Error('Falha em todos os proxies');
                }
                
                const totalTaxas = Object.keys(dadosPlanilha).length;
                atualizarStatus(`‚úÖ ${totalTaxas} taxas atualizadas da RFB`, true);
                statusConexao = 'online';
                
                await atualizarTodasLinhas();
                
            } catch (error) {
                console.error('Erro ao buscar dados:', error);
                carregarDadosHistoricosCompletos();
                atualizarStatus('‚ö†Ô∏è Usando dados hist√≥ricos (podem estar desatualizados)', false);
                statusConexao = 'offline';
            }
        }
        
        function extrairDadosCompletoDaPlanilha(html) {
            const parser = new DOMParser();
            const doc = parser.parseFromString(html, 'text/html');
            
            console.log('=== EXTRAINDO DADOS COMPLETOS (1995-2030) ===');
            
            const tabelas = doc.querySelectorAll('table');
            
            for (const tabela of tabelas) {
                const linhas = tabela.querySelectorAll('tr');
                if (linhas.length < 5) continue;
                
                let cabecalhoAtual = null;
                
                linhas.forEach((linha) => {
                    const celulas = linha.querySelectorAll('td, th');
                    
                    if (celulas.length > 10 && ehLinhaComMeses(linha)) {
                        cabecalhoAtual = [];
                        celulas.forEach((celula, i) => {
                            if (i > 0) {
                                const numeroMes = identificarMes(celula.textContent.trim());
                                cabecalhoAtual.push(numeroMes);
                            }
                        });
                        
                    } else if (celulas.length > 10 && cabecalhoAtual) {
                        const ano = parseInt(celulas[0].textContent.trim());
                        
                        if (ano >= 1995 && ano <= 2030) {
                            celulas.forEach((celula, i) => {
                                if (i > 0 && i <= cabecalhoAtual.length && cabecalhoAtual[i-1]) {
                                    const mesNumero = cabecalhoAtual[i-1];
                                    const taxa = extrairNumeroTaxa(celula.textContent.trim());
                                    
                                    if (taxa !== null && mesNumero) {
                                        const chave = `${ano}-${mesNumero.toString().padStart(2, '0')}`;
                                        dadosPlanilha[chave] = taxa;
                                    }
                                }
                            });
                        }
                    }
                });
                
                if (Object.keys(dadosPlanilha).length > 200) break;
            }
        }
        
        function ehLinhaComMeses(linha) {
            const texto = linha.textContent.toLowerCase();
            const mesesNomes = ['jan', 'fev', 'mar', 'abr', 'mai', 'jun', 'jul', 'ago', 'set', 'out', 'nov', 'dez'];
            return mesesNomes.filter(mes => texto.includes(mes)).length >= 6;
        }
        
        function identificarMes(textoMes) {
            const texto = textoMes.toLowerCase().trim();
            const meses = {
                'jan': 1, 'janeiro': 1, 'fev': 2, 'fevereiro': 2, 'mar': 3, 'mar√ßo': 3,
                'abr': 4, 'abril': 4, 'mai': 5, 'maio': 5, 'jun': 6, 'junho': 6,
                'jul': 7, 'julho': 7, 'ago': 8, 'agosto': 8, 'set': 9, 'setembro': 9,
                'out': 10, 'outubro': 10, 'nov': 11, 'novembro': 11, 'dez': 12, 'dezembro': 12
            };
            
            for (const [nome, numero] of Object.entries(meses)) {
                if (texto.includes(nome)) return numero;
            }
            return null;
        }
        
        function extrairNumeroTaxa(texto) {
            if (!texto || texto.trim() === '' || texto.trim() === '-') return null;
            
            let numeroLimpo = texto.replace(/[^\d,.-]/g, '').replace(',', '.');
            const numero = parseFloat(numeroLimpo);
            
            return (!isNaN(numero) && numero >= 0 && numero <= 100) ? numero : null;
        }
        
        function carregarDadosHistoricosCompletos() {
            dadosPlanilha = {
                '1995-02': 42.8, '1995-03': 39.4, '1995-04': 38.2, '1995-05': 36.1,
                '1995-06': 34.8, '1995-07': 33.2, '1995-08': 31.9, '1995-09': 30.5,
                '1995-10': 29.1, '1995-11': 27.8, '1995-12': 26.4,
                
                '2024-01': 1.07, '2024-02': 0.94, '2024-03': 0.94, '2024-04': 0.91,
                '2024-05': 0.91, '2024-06': 0.88, '2024-07': 0.88, '2024-08': 0.88,
                '2024-09': 0.84, '2024-10': 0.84, '2024-11': 0.84, '2024-12': 0.84,
                '2025-01': 1.13, '2025-02': 1.07, '2025-03': 1.07, '2025-04': 1.01,
                '2025-05': 1.01, '2025-06': 0.95, '2025-07': 1.28, '2025-08': 1.16,
                '2025-09': 1.00, '2025-10': 1.00, '2025-11': 1.00, '2025-12': 1.00
            };
            
            for (let ano = 1995; ano <= 2030; ano++) {
                for (let mes = 1; mes <= 12; mes++) {
                    const chave = `${ano}-${mes.toString().padStart(2, '0')}`;
                    if (!dadosPlanilha[chave]) {
                        if (ano >= 1995 && ano < 2000) dadosPlanilha[chave] = 20.0 - (ano - 1995) * 2;
                        else if (ano >= 2000 && ano < 2010) dadosPlanilha[chave] = 8.0 - (ano - 2000) * 0.5;
                        else if (ano >= 2010 && ano < 2020) dadosPlanilha[chave] = 3.0 - (ano - 2010) * 0.2;
                        else dadosPlanilha[chave] = 1.0;
                    }
                }
            }
            
            console.log(`üìö ${Object.keys(dadosPlanilha).length} taxas hist√≥ricas carregadas`);
        }
        
        function obterTaxaMes(ano, mes) {
            const chave = `${ano}-${mes.toString().padStart(2, '0')}`;
            return dadosPlanilha[chave] || 1.00;
        }
        
        function calcularTaxaSelicAcumulada(dataVencimento, dataPagamento) {
            const [mesVenc, anoVenc] = dataVencimento.split('/').map(Number);
            const [mesPag, anoPag] = dataPagamento.split('/').map(Number);
            
            if (anoPag < anoVenc || (anoPag === anoVenc && mesPag <= mesVenc)) {
                return 0;
            }
            
            let somaTaxas = 0;
            let anoAtual = anoVenc;
            let mesAtual = mesVenc;
            let detalhes = [];
            
            console.log(`=== C√ÅLCULO: ${dataVencimento} ‚Üí ${dataPagamento} ===`);
            
            while (anoAtual < anoPag || (anoAtual === anoPag && mesAtual < mesPag)) {
                mesAtual++;
                if (mesAtual > 12) {
                    mesAtual = 1;
                    anoAtual++;
                }
                
                const taxaMensal = obterTaxaMes(anoAtual, mesAtual);
                somaTaxas += taxaMensal;
                
                const nomes = ['', 'Jan', 'Fev', 'Mar', 'Abr', 'Mai', 'Jun', 'Jul', 'Ago', 'Set', 'Out', 'Nov', 'Dez'];
                detalhes.push(`${nomes[mesAtual]}/${anoAtual}:${taxaMensal.toFixed(2)}%`);
            }
            
            console.log(`üìã SOMA: ${detalhes.join(' + ')} = ${somaTaxas.toFixed(2)}%`);
            return somaTaxas;
        }
        
        function formatarData(input) {
            let valor = input.value.replace(/\D/g, '');
            
            if (valor.length >= 6) {
                valor = valor.substring(0, 2) + '/' + valor.substring(2, 6);
            } else if (valor.length === 5) {
                valor = '0' + valor.substring(0, 1) + '/' + valor.substring(1, 5);
            }
            
            const regex = /^(0[1-9]|1[0-2])\/\d{4}$/;
            if (regex.test(valor)) {
                const [mes, ano] = valor.split('/').map(Number);
                if (ano >= 1995 && ano <= 2030) {
                    input.value = valor;
                } else {
                    input.value = '';
                    mostrarAlerta('Data inv√°lida. Use entre 1995 e 2030.', 'error');
                }
            } else if (valor.length >= 6) {
                input.value = '';
                mostrarAlerta('Data inv√°lida. Use formato MM/AAAA', 'error');
            }
        }
        
        function moedaParaNumero(valorMoeda) {
            if (!valorMoeda) return 0;
            return parseFloat(valorMoeda.replace(/\./g, '').replace(',', '.'));
        }
        
        function numeroParaMoeda(numero) {
            if (isNaN(numero)) return '0,00';
            return numero.toFixed(2).replace('.', ',').replace(/(\d)(?=(\d{3})+(?!\d))/g, '$1.');
        }
        
        async function calcularLinha(indice) {
            const linha = document.querySelector(`[data-linha="${indice}"]`);
            if (!linha) return;
            
            const valorPagamento = linha.querySelector('.valor-pagamento').value;
            const dataPagamento = linha.querySelector('.data-pagamento').value;
            const taxaSelicInput = linha.querySelector('.taxa-selic');
            const valorAtualizadoInput = linha.querySelector('.valor-atualizado');
            
            const mesReferencia = document.getElementById('mesReferencia').value;
            
            if (!valorPagamento || !dataPagamento || !mesReferencia) {
                taxaSelicInput.value = '';
                valorAtualizadoInput.value = '';
                calcularTotal();
                return;
            }
            
            const regexData = /^(0[1-9]|1[0-2])\/\d{4}$/;
            if (!regexData.test(dataPagamento) || !regexData.test(mesReferencia)) {
                taxaSelicInput.value = 'Data inv√°lida';
                valorAtualizadoInput.value = '';
                calcularTotal();
                return;
            }
            
            taxaSelicInput.value = 'Calculando...';
            taxaSelicInput.classList.add('loading');
            
            try {
                await new Promise(resolve => setTimeout(resolve, 400));
                
                const taxaSelic = calcularTaxaSelicAcumulada(dataPagamento, mesReferencia);
                
                taxaSelicInput.value = taxaSelic.toFixed(2).replace('.', ',') + '%';
                taxaSelicInput.classList.remove('loading');
                
                const valorNumerico = moedaParaNumero(valorPagamento);
                const valorAtualizado = valorNumerico * (1 + taxaSelic / 100);
                
                valorAtualizadoInput.value = numeroParaMoeda(valorAtualizado);
                
                const fonte = statusConexao === 'online' ? 'üåê' : 'üíæ';
                mostrarAlerta(`${fonte} ${dataPagamento}‚Üí${mesReferencia} = ${taxaSelic.toFixed(2)}%`, 'success');
                
            } catch (error) {
                taxaSelicInput.value = 'Erro';
                taxaSelicInput.classList.remove('loading');
                valorAtualizadoInput.value = '';
                mostrarAlerta('Erro no c√°lculo.', 'error');
            }
            
            calcularTotal();
        }
        
        function calcularTotal() {
            let total = 0;
            document.querySelectorAll('.valor-atualizado').forEach(input => {
                const valor = moedaParaNumero(input.value);
                if (valor > 0) total += valor;
            });
            
            document.getElementById('valorTotal').value = numeroParaMoeda(total);
        }
        
        function adicionarLinha() {
            console.log(`üîÑ Adicionando linha ${contadorLinhas}...`);
            
            const tbody = document.querySelector('#tabelaSelic tbody');
            const linhaVazia = tbody.querySelector('.empty-row');
            
            if (!linhaVazia) {
                console.error('‚ùå Linha vazia n√£o encontrada');
                mostrarAlerta('Erro: Estrutura da tabela incorreta.', 'error');
                return;
            }
            
            const tr = document.createElement('tr');
            tr.className = 'data-row';
            tr.setAttribute('data-linha', contadorLinhas);
            
            tr.innerHTML = `
                <td class="white-cell">
                    <input type="text" class="valor-pagamento" placeholder="0,00" onblur="formatarMoeda(this); calcularLinha(${contadorLinhas})">
                </td>
                <td class="white-cell">
                    <input type="text" class="data-pagamento" placeholder="MM/AAAA" maxlength="7" onblur="formatarData(this); calcularLinha(${contadorLinhas})">
                </td>
                <td class="gray-cell">
                    <input type="text" class="taxa-selic" readonly>
                </td>
                <td class="gray-cell">
                    <input type="text" class="valor-atualizado" readonly>
                </td>
            `;
            
            tbody.insertBefore(tr, linhaVazia);
            contadorLinhas++;
            console.log(`‚úÖ Linha ${contadorLinhas - 1} adicionada com sucesso!`);
            mostrarAlerta(`‚úÖ Nova linha adicionada!`, 'success');
        }
        
        function removerLinha() {
            const linhasData = document.querySelectorAll('.data-row[data-linha]');
            if (linhasData.length > 1) {
                const ultimaLinha = linhasData[linhasData.length - 1];
                const idRemovido = ultimaLinha.getAttribute('data-linha');
                ultimaLinha.remove();
                calcularTotal();
                console.log(`üóëÔ∏è Linha ${idRemovido} removida`);
                mostrarAlerta('‚úÖ Linha removida.', 'success');
            } else {
                mostrarAlerta('‚ö†Ô∏è Mantenha pelo menos uma linha.', 'error');
            }
        }
        
       // Guardar a fun√ß√£o original para chamar dentro da nova
const atualizarTodasLinhasOriginal = atualizarTodasLinhas;

async function atualizarTodasLinhas() {
    const linhas = document.querySelectorAll('[data-linha]');
    
    for (let i = 0; i < linhas.length; i++) {
        const indice = linhas[i].getAttribute('data-linha');
        await calcularLinha(parseInt(indice));
        await new Promise(resolve => setTimeout(resolve, 100));
    }

    mostrarModalUltimaTaxa();
}

function criarModalUltimaTaxa() {
    if (document.getElementById('modalUltimaTaxa')) return;

    const modal = document.createElement('div');
    modal.id = 'modalUltimaTaxa';
    modal.style.display = 'none';
    modal.style.position = 'fixed';
    modal.style.zIndex = '9999';
    modal.style.left = '0';
    modal.style.top = '0';
    modal.style.width = '100%';
    modal.style.height = '100%';
    modal.style.overflow = 'auto';
    modal.style.backgroundColor = 'rgba(0,0,0,0.4)';
    modal.style.fontFamily = 'Arial, sans-serif';

    modal.innerHTML = `
        <div style="
            background-color: #fefefe;
            margin: 15% auto;
            padding: 20px 30px;
            border: 1px solid #888;
            width: 400px;
            border-radius: 8px;
            box-shadow: 0 4px 10px rgba(0,0,0,0.3);
            text-align: center;
            position: relative;
            font-weight: bold;
            font-size: 16px;
        ">
            <p id="textoUltimaTaxa" style="margin-top: 20px;"></p>
            <button id="btnOkModal" style="
                background-color: #1f4e79;
                color: white;
                border: none;
                padding: 10px 20px;
                border-radius: 4px;
                cursor: pointer;
                font-size: 14px;
                font-weight: bold;
                margin-top: 15px;
            ">OK</button>
        </div>
    `;

    document.body.appendChild(modal);

    // Fechar APENAS ao clicar no bot√£o OK
    document.getElementById('btnOkModal').onclick = () => {
        modal.style.display = 'none';
    };
}

function mostrarModalUltimaTaxa() {
    criarModalUltimaTaxa();

    const chaves = Object.keys(dadosPlanilha);
    if (chaves.length === 0) return;

    chaves.sort();
    const ultimaChave = chaves[chaves.length - 1];
    const taxa = dadosPlanilha[ultimaChave];

    const [anoUltima, mesUltima] = ultimaChave.split('-').map(Number);

    // Obter m√™s/ano atual
    const agora = new Date();
    let mesAtual = agora.getMonth() + 1; // 1-12
    let anoAtual = agora.getFullYear();

    // Calcular m√™s anterior
    let mesAnterior = mesAtual - 1;
    let anoAnterior = anoAtual;
    if (mesAnterior === 0) {
        mesAnterior = 12;
        anoAnterior--;
    }

    // Verificar se √∫ltima taxa √© do m√™s anterior
    const ehAtualizado = (anoUltima === anoAnterior && mesUltima === mesAnterior);

    // T√≠tulo din√¢mico
    const titulo = ehAtualizado ? 'ATUALIZADO!' : 'AGUARDANDO ATUALIZA√á√ÉO...';

    // Calcular pr√≥ximo m√™s ap√≥s a √∫ltima taxa
    let mesProx = mesUltima + 1;
    let anoProx = anoUltima;
    if (mesProx > 12) {
        mesProx = 1;
        anoProx++;
    }
    const mesProxFormatado = mesProx.toString().padStart(2, '0');
    const anoProxFormatado = anoProx.toString();

    // Texto em duas linhas: √∫ltima taxa + pr√≥xima estimada (1,00%)
    const [ano, mes] = ultimaChave.split('-');
    const mesFormatado = mes.padStart(2, '0'); // Garante 2 d√≠gitos
    const textoFormatado = `${titulo}<br><br>${taxa.toFixed(2).replace('.', ',')}% (${mesFormatado}/${ano})<br>1,00% (${mesProxFormatado}/${anoProxFormatado})`;

    const modal = document.getElementById('modalUltimaTaxa');
    const textoElemento = document.getElementById('textoUltimaTaxa');
    if (modal && textoElemento) {
        textoElemento.innerHTML = textoFormatado;
        modal.style.display = 'block';
    }
}


        
        // **INICIALIZA√á√ÉO COM M√äS VIGENTE**
        window.onload = function() {
            console.log('üöÄ CALC IBAMA inicializando...');
            
            // Definir m√™s vigente antes de carregar dados
            definirMesVigente();
            
            const mesDefinido = document.getElementById('mesReferencia').value;
            console.log(`üìÖ Sistema iniciado com m√™s de refer√™ncia: ${mesDefinido}`);
            
            buscarDadosOnline().then(() => {
                mostrarAlerta(`‚úÖ Sistema pronto! M√™s de refer√™ncia: ${mesDefinido}`, 'success');
            }).catch(() => {
                mostrarAlerta(`‚ö†Ô∏è Sistema carregado com dados locais. M√™s: ${mesDefinido}`, 'success');
            });
        };
    </script>
</body>
</html>
